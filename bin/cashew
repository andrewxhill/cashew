#!/bin/bash

set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
selector="$script_dir/cashew-select"
status="$script_dir/cashew-status"

ensure_session() {
    if ! tmux has-session -t cashew 2>/dev/null; then
        tmux new-session -d -s cashew -n cashew-ui
    fi

    if ! tmux list-windows -t cashew -F '#W' | grep -q '^cashew-ui$'; then
        tmux new-window -t cashew -n cashew-ui
    fi

    tmux select-window -t cashew:cashew-ui

    local pane_count
    pane_count=$(tmux list-panes -t cashew:cashew-ui | wc -l | tr -d ' ')
    if [ "$pane_count" -lt 2 ]; then
        tmux split-window -h -p 60 -t cashew:cashew-ui
    fi

    local left_pane
    local right_pane
    left_pane=$(tmux list-panes -t cashew:cashew-ui -F '#{pane_id} #{pane_index}' | awk '$2==0 {print $1; exit}')
    right_pane=$(tmux list-panes -t cashew:cashew-ui -F '#{pane_id} #{pane_index}' | awk '$2==1 {print $1; exit}')

    tmux set-option -gq @cashew_left_pane "$left_pane"
    tmux set-option -gq @cashew_right_pane "$right_pane"

    tmux send-keys -t "$left_pane" "clear; $selector" C-m
    tmux send-keys -t "$right_pane" "clear; $status idle" C-m
    tmux select-pane -t "$left_pane"
}

if ! command -v tmux >/dev/null 2>&1; then
    echo "tmux is required to run Cashew." >&2
    exit 1
fi

ensure_session

if [ -n "${TMUX:-}" ]; then
    tmux switch-client -t cashew
else
    tmux attach -t cashew
fi
